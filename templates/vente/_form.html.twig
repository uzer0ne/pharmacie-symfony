{{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': true}}) }}
<div class="card shadow-sm">
    <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-cart-plus"></i>
            {{ button_label|default('Enregistrer la Vente') }}
        </h5>
    </div>
    
    <div class="card-body">
        <div class="row">
            <!-- Colonne Infos Vente -->
            <div class="col-md-6">
                <h6 class="text-success mb-3 border-bottom pb-2">
                    <i class="bi bi-info-circle"></i> Informations Générales
                </h6>
                <div class="mb-3">
                    {{ form_label(form.patient) }}
                    {{ form_widget(form.patient, {'attr': {'class': 'form-select'}}) }}
                    <div class="form-text">Optionnel. Laissez vide pour une vente libre.</div>
                </div>
                <div class="mb-3">
                    {{ form_label(form.ordonnance) }}
                    {{ form_widget(form.ordonnance, {'attr': {'class': 'form-select'}}) }}
                    <div class="form-text">Optionnel. Liez une ordonnance à cette vente.</div>
                </div>
            </div>

            <!-- Colonne Messages -->
            <div class="col-md-6">
                <h6 class="text-success mb-3 border-bottom pb-2">
                    <i class="bi bi-exclamation-circle"></i> Notifications
                </h6>
                {{ form_errors(form) }}
                {{ form_errors(form.ligneVentes) }}

                <div class="alert alert-light" role="alert">
                    <i class="bi bi-lightbulb"></i> Les erreurs de stock s'afficheront ici après validation.
                </div>
            </div>
        </div>

        <!-- Section: Lignes de Vente (Collection) -->
        <div class="card shadow-sm mb-4 mt-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0 text-success">
                    <i class="bi bi-list-ul"></i> Produits de la Vente
                </h5>
            </div>
            <div class="card-body">
                
                <div id="ligne-ventes-list">
                    {% for ligneVenteForm in form.ligneVentes %}
                        <div class="ligne-vente-item mb-3 p-3 border rounded bg-light">
                            {{ form_row(ligneVenteForm) }}
                            <div class="text-end">
                                <button type="button" class="btn btn-danger btn-sm remove-btn"><i class="bi bi-trash"></i> Supprimer</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                {# IMPORTANT : type="button" empêche ce bouton de soumettre le formulaire #}
                <button type="button" class="btn btn-success add-ligne-vente-btn">
                    <i class="bi bi-plus-circle"></i> Ajouter un produit
                </button>
            </div>
        </div>
    </div>
    
    <div class="card-footer bg-light text-end">
        <a href="{{ path('app_vente_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Annuler
        </a>
        <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle"></i> 
            {{ button_label|default('Enregistrer la Vente') }}
        </button>
    </div>
</div>

{# ⭐ CORRECTION : On affiche manuellement le token CSRF car render_rest est à false #}
{{ form_row(form._token) }}
{{ form_end(form, {'render_rest': false}) }}

{# Prototype caché #}
<div id="ligne-vente-prototype-wrapper" 
     class="d-none"
     data-prototype="{{ form_widget(form.ligneVentes.vars.prototype)|e('html_attr') }}">
</div>

{# SCRIPT JS - Plus de {{ importmap }} ni de {% block %} #}
<script>
    function initVenteForm() {
        const addBtn = document.querySelector('.add-ligne-vente-btn');
        const list = document.querySelector('#ligne-ventes-list');
        const prototypeWrapper = document.querySelector('#ligne-vente-prototype-wrapper');

        if (!addBtn || !list || !prototypeWrapper) return;

        // Initialise l'index
        if (!list.dataset.index) {
            list.dataset.index = list.querySelectorAll('.ligne-vente-item').length;
        }

        // On remplace le bouton par un clone pour nettoyer les anciens événements (si Turbo)
        const newBtn = addBtn.cloneNode(true);
        addBtn.parentNode.replaceChild(newBtn, addBtn);

        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const prototype = prototypeWrapper.dataset.prototype;
            let index = parseInt(list.dataset.index);

            let newForm = prototype.replace(/__name__label__/g, index);
            newForm = newForm.replace(/__name__/g, index);

            const newItem = document.createElement('div');
            newItem.classList.add('ligne-vente-item', 'mb-3', 'p-3', 'border', 'rounded', 'bg-light');
            
            newItem.innerHTML = newForm + 
                '<div class="text-end">' +
                '<button type="button" class="btn btn-danger btn-sm remove-btn mt-2"><i class="bi bi-trash"></i> Supprimer</button>' +
                '</div>';

            list.appendChild(newItem);
            list.dataset.index = index + 1;
        });

        // Gestion suppression
        list.addEventListener('click', function(e) {
            if (e.target && (e.target.matches('.remove-btn') || e.target.closest('.remove-btn'))) {
                e.preventDefault();
                e.target.closest('.ligne-vente-item').remove();
            }
        });
    }

    // Supporte le chargement classique ET Turbo
    document.addEventListener('DOMContentLoaded', initVenteForm);
    document.addEventListener('turbo:load', initVenteForm);
</script>